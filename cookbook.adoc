// SPDX-License-Identifier: AGPL-3.0-or-later
// SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
= Sparkle-SSG Cookbook
:toc: left
:toclevels: 3
:sectnums:
:icons: font
:source-highlighter: rouge

A comprehensive guide to CLI commands, Nickel formulae, Just recipes, and command combinatorics for sparkle-ssg.

== Quick Reference

[cols="1,2,1"]
|===
|Section |Description |Jump To

|<<cli-commands>>
|Direct CLI commands for Deno runtime
|<<cli-commands>>

|<<just-recipes>>
|Justfile task automation
|<<just-recipes>>

|<<nickel-formulae>>
|Mustfile declarative specifications
|<<nickel-formulae>>

|<<combinatorics>>
|Command permutations and pipelines
|<<combinatorics>>

|<<hooks>>
|Git and CI/CD hooks configuration
|<<hooks>>

|<<security>>
|Security validation and hardening
|<<security>>
|===

[[cli-commands]]
== CLI Commands

Direct commands using the Deno runtime.

=== Basic Operations

[source,bash]
----
# Type check all adapters
deno check adapters/*.js

# Lint adapters
deno lint adapters/

# Format code
deno fmt adapters/

# Run tests
deno test tests/ --allow-read --allow-run

# Run tests with coverage
deno test --coverage=coverage/ tests/ --allow-all
deno coverage coverage/ --lcov > coverage/lcov.info
----

=== Adapter Operations

[source,bash]
----
# List all adapters
ls -1 adapters/*.js | grep -v validation.js | xargs -I{} basename {} .js

# Check specific adapter
deno check adapters/zola.js

# Run adapter in REPL
deno repl --eval "import * as zola from './adapters/zola.js'"

# Import and use adapter
deno eval "
import { getAdapter, listAdapters } from './adapters/mod.js';
console.log('Adapters:', listAdapters());
const zola = await getAdapter('zola');
console.log('Zola tools:', zola.tools.map(t => t.name));
"
----

=== Module Entry Point

[source,bash]
----
# Get adapter count
deno eval "import { adapterCount } from './adapters/mod.js'; console.log(adapterCount());"

# Get metadata
deno eval "import { metadata } from './adapters/mod.js'; console.log(JSON.stringify(metadata, null, 2));"

# List all adapters
deno eval "import { listAdapters } from './adapters/mod.js'; console.log(listAdapters().join('\n'));"
----

[[just-recipes]]
== Just Recipes

Justfile provides task automation for common operations.

=== Core Commands

[source,bash]
----
# Show all available commands
just

# Build everything
just build

# Run all checks (lint, format, security)
just check

# Run all tests
just test

# Run tests with coverage
just test-coverage

# Run all test suites
just test-all
----

=== Build & Compile

[source,bash]
----
# Build validation module
just build-validation

# Build all adapters
just build-adapters

# Compile/bundle for distribution
just compile
----

=== Linting & Formatting

[source,bash]
----
# Lint files
just lint

# Check formatting
just fmt-check

# Format files
just fmt

# Security check
just security-check
----

=== Adapter Management

[source,bash]
----
# List all adapters
just adapters

# Sync from hub
just sync-adapters

# Validate specific adapter
just validate-adapter zola
just validate-adapter hakyll
----

=== Development Tools

[source,bash]
----
# Start language server
just lsp

# Type check
just typecheck

# Initialize dev environment
just init

# Clean build artifacts
just clean
----

=== CI/CD & Release

[source,bash]
----
# Pre-commit checks
just pre-commit

# Prepare release
just release-prep 0.3.0

# Show project status
just status

# Show version
just version
----

=== Container Operations

[source,bash]
----
# Build container
just container-build

# Run in container
just container-run
----

=== Generator

[source,bash]
----
# Generate new adapter from template
just generate-adapter newadapter Rust NewSSG
----

[[nickel-formulae]]
== Nickel Formulae

Mustfile provides declarative build specifications.

=== Must Recipes (Required)

These recipes must pass before merge:

[source,toml]
----
[must.build]      # Build all components
[must.test]       # Run all tests
[must.lint]       # Lint all source files
[must.format]     # Check code formatting
[must.security]   # Security vulnerability check
[must.typecheck]  # Type check all modules
----

Run all must recipes:
[source,bash]
----
just check && just test && just typecheck
----

=== Should Recipes (Recommended)

[source,toml]
----
[should.coverage]  # Test coverage (target: 70%)
[should.e2e]       # End-to-end tests
[should.docs]      # Documentation generation
----

=== Could Recipes (Optional)

[source,toml]
----
[could.container]  # Container image build
[could.bundle]     # Distribution bundle
----

=== Pipeline Stages

[source,toml]
----
[pipeline.stages]
order = ["build", "lint", "test", "security", "deploy"]

[pipeline.build]
depends_on = []
artifacts = ["dist/"]

[pipeline.test]
depends_on = ["build"]
artifacts = ["coverage/"]

[pipeline.security]
depends_on = ["build"]
artifacts = ["security-report.json"]

[pipeline.deploy]
depends_on = ["test", "security"]
environment = "production"
----

=== Nickel Schema: Adapters

[source,nickel]
----
{
  adapters : Array { name : String, language : String, ssg : String },
  validation : { module : String, functions : Array String },
  runtime : { engine : String, version : String }
}
----

=== Nickel Schema: Security

[source,nickel]
----
{
  input_validation : Bool,
  path_traversal_prevention : Bool,
  command_injection_prevention : Bool,
  safe_run_command : Bool
}
----

=== Nickel Schema: Compliance

[source,nickel]
----
{
  spdx_headers : Bool,
  sha_pinned_actions : Bool,
  codeql_enabled : Bool,
  signed_commits : Bool,
  min_coverage : Num
}
----

[[combinatorics]]
== Command Combinatorics

Powerful command combinations and pipelines.

=== Sequential Operations

[source,bash]
----
# Full CI pipeline
just check && just test && just security-check

# Build and test
just build && just test

# Format, lint, and test
just fmt && just lint && just test

# Complete pre-release
just check && just test-all && just release-prep 0.3.0
----

=== Parallel Operations

[source,bash]
----
# Parallel lint and test (with GNU parallel)
parallel ::: "just lint" "just test"

# Parallel adapter checks
ls adapters/*.js | grep -v validation.js | parallel deno check {}

# Parallel test suites
parallel ::: "just test-unit" "just test-validation"
----

=== Adapter Iteration

[source,bash]
----
# Check all adapters
for adapter in $(just adapters | tail -n +2); do
  just validate-adapter $adapter
done

# Test all Rust SSG adapters
for ssg in zola cobalt mdbook; do
  echo "Testing $ssg..."
  deno eval "import { getAdapter } from './adapters/mod.js'; const a = await getAdapter('$ssg'); console.log(a.name, a.language);"
done

# Export adapter list to JSON
deno eval "import { listAdapters } from './adapters/mod.js'; console.log(JSON.stringify(listAdapters()));" > adapters.json
----

=== Pipeline Compositions

[source,bash]
----
# CI/CD full pipeline
just clean && \
just init && \
just build && \
just check && \
just test-all && \
just container-build

# Development cycle
just fmt && just lint && just test && git add -A && git commit

# Release pipeline
just test-all && \
just release-prep $VERSION && \
git tag v$VERSION && \
git push --tags
----

=== Filter and Transform

[source,bash]
----
# Find adapters by language
grep -l "language = \"Rust\"" adapters/*.js

# Count tools per adapter
for f in adapters/*.js; do
  name=$(basename $f .js)
  count=$(grep -c "name:" $f 2>/dev/null || echo 0)
  echo "$name: $count tools"
done

# Export adapter metadata
deno eval "
import { adapters } from './adapters/mod.js';
for (const [name, loader] of Object.entries(adapters)) {
  const a = await loader();
  console.log(\`\${name},\${a.language},\${a.tools.length}\`);
}
" > adapters-metadata.csv
----

=== Conditional Execution

[source,bash]
----
# Only test if changed
git diff --name-only | grep -q "adapters/" && just test

# Sync only if hub changed
git -C ../poly-ssg-mcp log -1 --format=%H > /tmp/hub-hash
[ "$(cat .hub-hash 2>/dev/null)" != "$(cat /tmp/hub-hash)" ] && just sync-adapters

# Build container only on release
[[ "$CI_COMMIT_TAG" =~ ^v[0-9] ]] && just container-build
----

[[hooks]]
== Hooks Configuration

Git and CI/CD hooks for automation.

=== Git Pre-commit Hook

[source,bash]
----
#!/bin/bash
# .git/hooks/pre-commit

set -e

echo "Running pre-commit checks..."

# Format check
just fmt-check || {
  echo "Format check failed. Run 'just fmt' to fix."
  exit 1
}

# Lint
just lint || {
  echo "Lint failed. Fix issues before committing."
  exit 1
}

echo "Pre-commit checks passed!"
----

=== Git Pre-push Hook

[source,bash]
----
#!/bin/bash
# .git/hooks/pre-push

set -e

echo "Running pre-push checks..."

# Full test suite
just test || {
  echo "Tests failed. Fix before pushing."
  exit 1
}

# Security check
just security-check || {
  echo "Security check failed. Review issues."
  exit 1
}

echo "Pre-push checks passed!"
----

=== Git Post-merge Hook

[source,bash]
----
#!/bin/bash
# .git/hooks/post-merge

echo "Syncing adapters from hub..."
just sync-adapters || true

echo "Post-merge complete."
----

=== GitHub Actions Workflow Hooks

[source,yaml]
----
# .github/workflows/ci.yml hooks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # Weekly security scan

jobs:
  # Pre-merge hooks
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: denoland/setup-deno@v1
      - run: just lint

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: denoland/setup-deno@v1
      - run: just test-all

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: github/codeql-action/init@v3
      - uses: github/codeql-action/analyze@v3
----

=== Mustfile Hook Configuration

[source,toml]
----
[hooks.pre-commit]
commands = ["just fmt", "just lint"]
blocking = true

[hooks.pre-push]
commands = ["just test", "just security-check"]
blocking = true

[hooks.post-merge]
commands = ["just sync-adapters"]
blocking = false
----

[[security]]
== Security Validation

Security-focused commands and validation.

=== Input Validation Functions

[source,javascript]
----
// Available in validation.js
isValidPath(path)        // Prevent path traversal
isValidArgument(arg)     // Prevent command injection
isValidUrl(url)          // Validate URLs (http/https only)
isValidPort(port)        // Validate port numbers (1-65535)
isValidInterface(iface)  // Validate network interfaces
sanitizePath(base, user) // Normalize and validate paths
safeRunCommand(bin, args, cwd) // Execute with validation
----

=== Security Checks

[source,bash]
----
# Check for injection patterns
just security-check

# Manual injection pattern search
grep -rn "eval\|exec\|spawn" adapters/

# Check for hardcoded secrets
grep -rn "password\|secret\|api_key\|token" --include="*.js"

# Validate all paths are checked
grep -L "isValidPath" adapters/*.js | grep -v validation.js
----

=== Security Test Suite

[source,bash]
----
# Run security-specific tests
deno test tests/validation.test.js --allow-read

# Test path traversal prevention
deno eval "
import { isValidPath } from './adapters/validation.js';
console.log('Path traversal blocked:', !isValidPath('../../../etc/passwd'));
console.log('Shell injection blocked:', !isValidPath('path;rm -rf /'));
"
----

=== CodeQL Configuration

[source,bash]
----
# Run local CodeQL analysis (if installed)
codeql database create db --language=javascript
codeql database analyze db javascript-security-and-quality.qls --format=sarif-latest

# View GitHub CodeQL results
gh api repos/{owner}/{repo}/code-scanning/alerts
----

== Environment Setup

=== Requirements

[source,bash]
----
# Check Deno version
deno --version  # Requires >= 1.40.0

# Check Just version
just --version  # Requires >= 1.0.0

# Optional: Check Podman/Docker
podman --version || docker --version
----

=== Development Setup

[source,bash]
----
# Clone and setup
git clone https://github.com/hyperpolymath/sparkle-ssg
cd sparkle-ssg

# Initialize directories
just init

# Verify setup
just check

# Run tests
just test
----

=== IDE Integration

[source,bash]
----
# Start Deno LSP (for VS Code, etc.)
just lsp

# Or directly
deno lsp
----

== Troubleshooting

=== Common Issues

[cols="1,2"]
|===
|Issue |Solution

|Deno not found
|Install via `curl -fsSL https://deno.land/install.sh \| sh`

|Just not found
|Install via `cargo install just` or package manager

|Tests failing
|Run `just init` to create directories

|Lint errors
|Run `just fmt` to auto-fix formatting

|Adapter not loading
|Check if SSG binary is installed
|===

=== Debug Mode

[source,bash]
----
# Verbose test output
deno test tests/ --allow-all -- --verbose

# Debug specific adapter
DENO_DEBUG=1 deno eval "import './adapters/zola.js'"

# Trace command execution
DEBUG=1 just test
----

---

_Last updated: 2025-12-22 Â· Generated from sparkle-ssg v0.2.0_
